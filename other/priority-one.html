<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>City Dispatcher ‚Äî Send Units & Manage Incidents</title>
    <style>
      :root {
        --bg: #0f1115;
        --panel: #161a22;
        --muted: #9fb3c8;
        --text: #e8eef7;
        --accent: #67e8f9;
        --danger: #ff6b6b;
        --ok: #8ef08e;
        --warn: #ffd166;
        --card: #10141c;
        --cardEdge: #1f2531;
        --shadow: 0 6px 30px rgba(0, 0, 0, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Arial;
      }

      /* Layout */
      .wrap {
        display: grid;
        grid-template-rows: auto 1fr auto;
        height: 100%;
      }
      header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: linear-gradient(180deg, #121722, #0e121a);
        border-bottom: 1px solid #202636;
        box-shadow: var(--shadow);
        flex-wrap: wrap;
      }
      header .pill {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #0e131d;
        border: 1px solid #222a39;
        padding: 8px 12px;
        border-radius: 999px;
        font-weight: 600;
      }
      header .pill strong {
        letter-spacing: 0.2px;
      }
      header .sep {
        width: 1px;
        height: 24px;
        background: #283144;
      }

      .main {
        display: grid;
        grid-template-columns: 360px 1fr 360px;
        gap: 12px;
        padding: 12px;
      }
      .panel {
        background: var(--panel);
        border: 1px solid #222a39;
        border-radius: 14px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .panel h2 {
        margin: 0;
        padding: 12px 14px;
        font-size: 14px;
        letter-spacing: 0.3px;
        border-bottom: 1px solid #212737;
        color: var(--muted);
      }
      .panel .body {
        padding: 10px;
        overflow: auto;
      }

      /* Incidents list */
      .incident {
        background: var(--card);
        border: 1px solid var(--cardEdge);
        border-radius: 12px;
        padding: 10px;
        margin: 8px 0;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        cursor: pointer;
      }
      .incident .meta {
        font-size: 12px;
        color: var(--muted);
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .incident .title {
        font-weight: 700;
      }
      .tag {
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #293142;
        background: #0d121b;
        font-size: 11px;
      }
      .tag.ok {
        color: var(--ok);
        border-color: #214826;
      }
      .tag.warn {
        color: var(--warn);
        border-color: #4a4124;
      }
      .tag.bad {
        color: var(--danger);
        border-color: #4a2323;
      }
      .progress {
        height: 6px;
        background: #0c1017;
        border: 1px solid #222a39;
        border-radius: 999px;
        overflow: hidden;
      }
      .progress > div {
        height: 100%;
        background: linear-gradient(90deg, #67e8f9, #8ef08e);
        width: 0;
      }
      .inc-actions {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .btn {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid #283142;
        background: #0e141e;
        color: var(--text);
        cursor: pointer;
        font-weight: 600;
      }
      .btn:hover {
        filter: brightness(1.2);
      }
      .btn.primary {
        background: linear-gradient(180deg, #1a2434, #131b29);
        border-color: #2b3650;
      }
      .btn.ghost {
        background: #0d121b;
      }
      .btn.danger {
        border-color: #4a2323;
        background: #1a0f11;
        color: #ffb3b3;
      }
      input[type="number"] {
        background: #0e141e;
        border: 1px solid #283142;
        color: var(--text);
        border-radius: 8px;
        padding: 6px 8px;
        width: 70px;
      }

      /* Missions & Patrols */
      .mission,
      .patrol {
        background: #0f1520;
        border: 1px solid #273046;
        border-radius: 12px;
        padding: 10px;
        margin: 8px 0;
      }
      .small {
        font-size: 12px;
        color: var(--muted);
      }

      /* Footer log */
      footer {
        border-top: 1px solid #202636;
        background: #0f141e;
      }
      #log {
        height: 120px;
        overflow: auto;
        padding: 10px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
      }
      #log .line {
        padding: 2px 0;
        color: #b8c6d9;
      }
      #log .good {
        color: #90f39a;
      }
      #log .bad {
        color: #ffa8a8;
      }
      #log .warn {
        color: #ffe08a;
      }

      /* Speed controls */
      .speed {
        display: flex;
        gap: 6px;
      }
      .speed .btn {
        padding: 6px 10px;
      }

      /* Shop modal (no blur, full screen) */
      .overlay {
        position: fixed;
        inset: 0;
        display: none;
      }
      .overlay.show {
        display: block;
      }
      .shop {
        position: absolute;
        inset: 0;
        background: rgba(5, 8, 13, 0.96);
        border-top: 1px solid #202636;
        display: grid;
        grid-template-rows: auto 1fr;
      }
      .shop header {
        border: 0;
        box-shadow: none;
        background: transparent;
        padding: 16px;
      }
      .shop .content {
        padding: 16px;
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(3, 1fr);
      }
      .shop .card {
        background: #0f1520;
        border: 1px solid #273046;
        border-radius: 14px;
        padding: 14px;
      }

      @media (max-width: 1100px) {
        .main {
          grid-template-columns: 1fr;
          grid-auto-rows: minmax(0, auto);
        }
        .shop .content {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="pill" title="Available officers">
          <strong>üëÆ Officers:</strong> <span id="officers">0</span>
        </div>
        <div class="pill" title="Cash on hand">
          <strong>üíµ Money:</strong> $<span id="money">0</span>
        </div>
        <div class="pill" title="Public reputation">
          <strong>‚≠ê Rep:</strong> <span id="rep">0</span>
        </div>
        <div class="pill" title="Day / Payroll">
          <strong>üóìÔ∏è Day:</strong> <span id="day">1</span>
        </div>
        <div class="sep"></div>
        <div class="speed">
          <button class="btn" id="pauseBtn">‚è∏Ô∏è Pause</button>
          <button class="btn" data-speed="1">‚ñ∂Ô∏è 1x</button>
          <button class="btn" data-speed="2">‚è© 2x</button>
          <button class="btn" data-speed="4">‚è≠Ô∏è 4x</button>
        </div>
        <div
          style="margin-left: auto; display: flex; gap: 8px; flex-wrap: wrap"
        >
          <button class="btn ghost" id="spawnBtn" title="Force a new incident">
            ‚ûï New Incident
          </button>
          <button class="btn primary" id="shopBtn" title="Open shop & upgrades">
            üè¨ Shop
          </button>
        </div>
      </header>

      <div class="main">
        <section class="panel" id="incidentsPanel">
          <h2>Active Incidents</h2>
          <div class="body" id="incidents"></div>
        </section>

        <section class="panel">
          <h2>Dispatch Center</h2>
          <div class="body">
            <div class="small" style="margin-bottom: 8px">
              Click an incident to pause time and prepare dispatch.
            </div>
            <div id="selectedArea" class="small">No incident selected.</div>
            <div
              id="dispatchControls"
              style="
                display: none;
                margin-top: 10px;
                display: grid;
                grid-template-columns: 1fr auto;
                gap: 8px;
                align-items: center;
              "
            >
              <div style="display: flex; gap: 8px; align-items: center">
                <label for="sendCount">Send</label>
                <input id="sendCount" type="number" min="1" value="1" />
                <button class="btn" id="fillReqBtn" title="Fill requirement">
                  Fill Req
                </button>
                <button
                  class="btn"
                  id="maxBtn"
                  title="Send as many as available"
                >
                  Max
                </button>
              </div>
              <div class="inc-actions">
                <button class="btn primary" id="dispatchBtn">Dispatch</button>
                <button class="btn ghost" id="clearBtn">Clear</button>
              </div>
            </div>

            <hr
              style="border: 0; border-top: 1px solid #212737; margin: 14px 0"
            />
            <h3 style="margin: 6px 0 0 0; font-size: 14px; color: var(--muted)">
              Units On Mission
            </h3>
            <div id="missions"></div>

            <hr
              style="border: 0; border-top: 1px solid #212737; margin: 14px 0"
            />
            <div style="display: flex; align-items: center; gap: 8px">
              <button class="btn" id="addPatrolBtn">
                ‚ûï New Patrol (1 officer)
              </button>
            </div>
            <div id="patrols"></div>
          </div>
        </section>

        <section class="panel">
          <h2>City Stats</h2>
          <div class="body">
            <div class="small">
              Incidents handled: <span id="handled">0</span>
            </div>
            <div class="small">Failures: <span id="failed">0</span></div>
            <div class="small">Officers lost: <span id="lost">0</span></div>
            <div class="small">
              Spawn interval: <span id="spawnInfo">‚Äî</span>
            </div>
            <div class="small">
              Patrol bonus: <span id="patrolBonus">0%</span>
            </div>
            <div class="small">
              Payroll / day: $<span id="payroll">0</span> (first 3 free)
            </div>
            <hr
              style="border: 0; border-top: 1px solid #212737; margin: 12px 0"
            />
            <div class="small">
              Tips:
              <ul>
                <li>
                  Selecting an incident pauses time. Dispatch or Clear to
                  resume.
                </li>
                <li>
                  If an incident spawns while at >1x, speed resets to 1x so you
                  can react.
                </li>
                <li>Unpaid payroll ‚Üí officers may quit.</li>
              </ul>
            </div>
          </div>
        </section>
      </div>

      <footer>
        <div id="log"></div>
      </footer>
    </div>

    <!-- SHOP OVERLAY -->
    <div class="overlay" id="shopOverlay" aria-hidden="true">
      <div class="shop">
        <header>
          <div
            style="display: flex; gap: 12px; align-items: center; width: 100%"
          >
            <div class="pill"><strong>üè¨ Shop</strong></div>
            <div class="pill">
              <strong>üíµ</strong> $<span id="shopMoney">0</span>
            </div>
            <div class="pill">
              <strong>üëÆ</strong> <span id="shopOfficers">0</span>
            </div>
            <button class="btn" id="closeShop" style="margin-left: auto">
              Close
            </button>
          </div>
        </header>
        <div class="content">
          <div class="card">
            <h3 style="margin: 0 0 6px">Hire Officers</h3>
            <div class="small">
              Cost: $150 each ‚Ä¢ Daily salary: $20 (first 3 officers free)
            </div>
            <div style="display: flex; gap: 8px; margin-top: 8px">
              <input id="hireCount" type="number" min="1" value="1" />
              <button class="btn primary" id="hireBtn">Hire</button>
            </div>
            <div id="hireMsg" class="small" style="margin-top: 6px"></div>
          </div>

          <div class="card">
            <h3 style="margin: 0 0 6px">Training Drill</h3>
            <div class="small">
              Assign 1 officer for 20s to gain +5% success for 90s. Cost $60.
            </div>
            <button class="btn" id="startDrillBtn">Start Drill</button>
            <div class="small" id="drillStatus" style="margin-top: 6px">
              No drill active.
            </div>
          </div>

          <div class="card">
            <h3 style="margin: 0 0 6px">City Funding</h3>
            <div class="small">
              Every 5 in-game days you receive $250 base funding.
            </div>
            <div class="small">Current day: <span id="shopDay">1</span></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        // ---------- GAME STATE ----------
        const state = {
          money: 500,
          reputation: 0,
          officersTotal: 5,
          officersFree: 5,
          baseFree: 3, // first N officers don't draw salary
          salaryPerOfficer: 20, // per day, beyond baseFree
          day: 1,
          msPerDay: 60000, // 60s = 1 in-game day
          nextDayAt: Date.now() + 60000,
          nextFundingDay: 6, // receive funding on days divisible by 5 (next is 6 because day starts at 1)
          spawnMin: 7000,
          spawnMax: 14000,
          speed: 1, // time multiplier
          paused: false,
          incidents: [], // {id,title,severity,required,expiresAt,createdAt,reward,penalty}
          missions: [], // {id,incidentId,units,resolveAt}
          patrols: [], // {id, units:1}
          selectedId: null,
          counters: { handled: 0, failed: 0, lost: 0 },
          nextIncidentId: 1,
          // drill buff
          drillBuff: { active: false, until: 0 },
        };

        // ---------- HELPERS ----------
        const $ = (sel) => document.querySelector(sel);
        const elIncidents = $("#incidents");
        const elMissions = $("#missions");
        const elPatrols = $("#patrols");
        const elLog = $("#log");

        function log(msg, cls = "") {
          const line = document.createElement("div");
          line.className = "line " + cls;
          line.textContent = msg;
          elLog.appendChild(line);
          elLog.scrollTop = elLog.scrollHeight;
        }
        function fmtTime(ms) {
          const s = Math.max(0, Math.ceil(ms / 1000));
          return s + "s";
        }
        function between(min, max) {
          return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        function pick(arr) {
          return arr[Math.floor(Math.random() * arr.length)];
        }

        // ---------- UI UPDATE ----------
        function renderHUD() {
          $("#officers").textContent =
            state.officersFree + " / " + state.officersTotal;
          $("#money").textContent = state.money.toFixed(0);
          $("#rep").textContent = state.reputation.toFixed(0);
          $("#handled").textContent = state.counters.handled;
          $("#failed").textContent = state.counters.failed;
          $("#lost").textContent = state.counters.lost;
          $("#spawnInfo").textContent =
            state.spawnMin / 1000 + "‚Äì" + state.spawnMax / 1000 + "s";
          $("#day").textContent = state.day;
          $("#patrolBonus").textContent =
            Math.round(getPatrolBonus() * 100) + "%";
          $("#payroll").textContent = getDailyPayroll();
        }

        function tagBySeverity(s) {
          if (s <= 2) return '<span class="tag ok">Low</span>';
          if (s === 3) return '<span class="tag warn">Medium</span>';
          return '<span class="tag bad">High</span>';
        }

        function renderIncidents() {
          elIncidents.innerHTML = "";
          const now = Date.now();
          state.incidents.sort((a, b) => a.expiresAt - b.expiresAt);
          state.incidents.forEach((inc) => {
            const card = document.createElement("div");
            card.className = "incident";
            card.dataset.id = inc.id;
            const left = document.createElement("div");
            const right = document.createElement("div");
            right.className = "inc-actions";

            left.innerHTML = `
        <div class="title">${inc.title}</div>
        <div class="meta">
          ${tagBySeverity(inc.severity)}
          <span class="tag">Req: ${inc.required}</span>
          <span class="tag">Reward: $${inc.reward}</span>
          <span class="tag">Penalty: $${inc.penalty}</span>
          <span class="tag">Time: <b>${fmtTime(inc.expiresAt - now)}</b></span>
        </div>
        <div class="progress" title="Time remaining"><div style="width:${
          (100 * (inc.expiresAt - now)) / (inc.expiresAt - inc.createdAt)
        }%"></div></div>
      `;

            const selBtn = document.createElement("button");
            selBtn.className = "btn";
            selBtn.textContent = "Select";
            selBtn.onclick = (e) => {
              e.stopPropagation();
              selectIncident(inc.id, true);
            };
            right.appendChild(selBtn);

            card.appendChild(left);
            card.appendChild(right);
            card.addEventListener("click", () => selectIncident(inc.id, true));
            elIncidents.appendChild(card);
          });
        }

        function renderMissions() {
          elMissions.innerHTML = "";
          const now = Date.now();
          state.missions.forEach((m) => {
            const inc =
              state.incidents.find((i) => i.id === m.incidentId) || m._snapshot;
            const div = document.createElement("div");
            div.className = "mission";
            const remaining = m.resolveAt - now;
            div.innerHTML = `
        <div><strong>${inc ? inc.title : "Mission"}</strong> ‚Äî units: <b>${
              m.units
            }</b></div>
        <div class="small">ETA: ${fmtTime(remaining)} | Severity: ${
              inc ? inc.severity : "?"
            } | Req: ${inc ? inc.required : "?"}</div>
        <div class="progress"><div style="width:${Math.max(
          0,
          100 * (1 - remaining / m.duration)
        )}%"></div></div>
      `;
            elMissions.appendChild(div);
          });
        }

        function renderPatrols() {
          elPatrols.innerHTML = "";
          if (state.patrols.length === 0) {
            const p = document.createElement("div");
            p.className = "small";
            p.textContent = "No patrols active.";
            elPatrols.appendChild(p);
            return;
          }
          state.patrols.forEach((pat) => {
            const div = document.createElement("div");
            div.className = "patrol";
            div.innerHTML = `<strong>Patrol #${pat.id}</strong> ‚Äî Units: ${pat.units}
        <div class="small">Provides small success boost. Removing returns officers.</div>
        <div style="margin-top:6px"><button class="btn danger" data-pid="${pat.id}">Remove patrol</button></div>`;
            div.querySelector("button").onclick = () => removePatrol(pat.id);
            elPatrols.appendChild(div);
          });
        }

        function selectIncident(id, pause) {
          state.selectedId = id;
          const inc = state.incidents.find((i) => i.id === id);
          const area = $("#selectedArea");
          if (!inc) {
            area.textContent = "No incident selected.";
            $("#dispatchControls").style.display = "none";
            return;
          }
          area.innerHTML = `<strong>${inc.title}</strong> ‚Äî ${tagBySeverity(
            inc.severity
          )} | Req <b>${inc.required}</b> | Time left <b>${fmtTime(
            inc.expiresAt - Date.now()
          )}</b>`;
          $("#dispatchControls").style.display = "grid";
          $("#sendCount").value = Math.min(inc.required, state.officersFree);
          if (pause) {
            state.paused = true;
            $("#pauseBtn").textContent = "‚ñ∂Ô∏è Resume";
            log(`‚è∏Ô∏è Paused to handle #${inc.id}.`, "warn");
          }
        }

        // ---------- GAME LOGIC ----------
        const TITLES = [
          "Burglary in progress",
          "Traffic collision",
          "Disturbance call",
          "Armed robbery",
          "Shoplifting",
          "Street fight",
          "Noise complaint",
          "Suspicious person",
          "Vandalism",
          "Assault report",
          "Car theft",
          "Domestic dispute",
          "Medical emergency",
        ];

        function spawnIncident() {
          const severity = between(1, 5);
          const required = Math.max(
            1,
            Math.min(6, Math.round(severity + Math.random() * 2))
          );
          const now = Date.now();
          const ttl = between(30000, 90000) - severity * 2000; // higher severity, shorter time
          const reward = 80 + severity * between(40, 90) + required * 25;
          const penalty = 40 + severity * between(30, 70);
          const inc = {
            id: state.nextIncidentId++,
            title: pick(TITLES),
            severity,
            required,
            createdAt: now,
            expiresAt: now + ttl,
            reward,
            penalty,
          };
          state.incidents.push(inc);
          renderIncidents();
          log(
            `üìü New incident #${inc.id}: ${inc.title} (sev ${severity}, req ${required}).`,
            "warn"
          );
          // If player is at >1x speed, reset to 1x and log
          if (state.speed > 1) {
            state.speed = 1;
            log("‚èØÔ∏è Speed reset to 1x due to new incident.", "warn");
          }
        }

        function dispatchSelected() {
          const inc = state.incidents.find((i) => i.id === state.selectedId);
          if (!inc) {
            log("No incident selected.", "warn");
            return;
          }
          const n = Math.max(1, Math.floor(Number($("#sendCount").value || 1)));
          if (n > state.officersFree) {
            log("Not enough free officers.", "warn");
            return;
          }

          // allocate officers and create mission
          state.officersFree -= n;
          const duration = between(8000, 15000) + inc.severity * 2000; // how long until resolution
          const mission = {
            id: "m" + crypto.randomUUID(),
            incidentId: inc.id,
            units: n,
            resolveAt: Date.now() + duration,
            duration,
            _snapshot: { ...inc },
          };
          state.missions.push(mission);

          // remove incident from active list (we're handling it)
          state.incidents = state.incidents.filter((x) => x.id !== inc.id);
          state.selectedId = null;
          renderIncidents();
          renderMissions();
          selectIncident(null);
          state.paused = false;
          $("#pauseBtn").textContent = "‚è∏Ô∏è Pause";
          log(`üöì Dispatched ${n} officer(s) to #${inc.id} (${inc.title}).`);
        }

        function getPatrolBonus() {
          // each patrol adds 2.5% (0.025) global success bonus, up to 10%
          return Math.min(0.1, state.patrols.length * 0.025);
        }

        function successCalc(m) {
          const inc = m._snapshot;
          const ratio = m.units / Math.max(1, inc.required);
          let base = 0.35 + 0.4 * Math.min(1.4, ratio); // up to ~0.91 cap before penalties
          base -= (inc.severity - 1) * 0.05; // severity tax
          base += getPatrolBonus(); // patrol help
          if (state.drillBuff.active) base += 0.05; // drill boost
          // time pressure already applied by shorter deadlines; keep bounded strictly
          base = Math.max(0.05, Math.min(0.95, base));
          return { ratio, base };
        }

        function resolveMission(m) {
          // success chance based on ratio and severity
          const { ratio, base } = successCalc(m);
          const inc = m._snapshot;

          // casualty chance rises if under-staffed & high severity
          const shortfall = Math.max(0, inc.required - m.units);
          const casualtyChance = Math.min(
            0.35,
            0.03 * inc.severity + 0.06 * shortfall
          );
          let lost = 0;
          for (let i = 0; i < m.units; i++)
            if (Math.random() < casualtyChance) lost++;

          const success = Math.random() < base;

          // Debug console logging for balance tuning
          console.log("[Mission]", {
            incident: inc.id,
            title: inc.title,
            units: m.units,
            required: inc.required,
            ratio,
            baseChance: base,
            patrols: state.patrols.length,
            drill: state.drillBuff.active,
          });

          state.officersTotal -= lost; // permanently lost

          if (success) {
            state.money += inc.reward;
            state.reputation += 1 + Math.max(0, inc.severity - 2) * 0.5;
            state.counters.handled++;
            log(
              `‚úÖ Resolved #${inc.id}: ${inc.title}. +$${inc.reward}${
                lost ? `, ‚ö†Ô∏è ${lost} officer(s) lost` : ""
              }`,
              lost ? "warn" : "good"
            );
          } else {
            state.money -= inc.penalty;
            state.reputation -= 1 + inc.severity * 0.5;
            state.counters.failed++;
            log(
              `‚ùå Failed #${inc.id}: ${inc.title}. -$${inc.penalty}${
                lost ? `, ‚ö†Ô∏è ${lost} officer(s) lost` : ""
              }`,
              "bad"
            );
          }

          // returning officers who survived
          const returned = Math.max(0, m.units - lost);
          state.officersFree += returned;
          renderHUD();
        }

        function failExpired(inc) {
          // time ran out
          state.money -= inc.penalty;
          state.reputation -= 1 + inc.severity * 0.5;
          state.counters.failed++;
          log(`‚åõ Incident #${inc.id} expired. -$${inc.penalty}`, "bad");
        }

        // ---------- PATROLS ----------
        function addPatrol() {
          if (state.officersFree < 1) {
            log("Need a free officer to start a patrol.", "warn");
            return;
          }
          state.officersFree -= 1;
          state.patrols.push({ id: state.patrols.length + 1, units: 1 });
          renderPatrols();
          renderHUD();
          log("üö® Started a new patrol (1 officer).");
        }
        function removePatrol(id) {
          const idx = state.patrols.findIndex((p) => p.id === id);
          if (idx >= 0) {
            state.patrols.splice(idx, 1);
            state.officersFree += 1;
            renderPatrols();
            renderHUD();
            log(`üß≠ Removed patrol #${id}.`);
          }
        }

        // ---------- ECONOMY ----------
        function getDailyPayroll() {
          const paidCount = Math.max(0, state.officersTotal - state.baseFree);
          return paidCount * state.salaryPerOfficer;
        }

        function onNewDay() {
          state.day += 1;
          // payroll
          const payroll = getDailyPayroll();
          state.money -= payroll;
          if (payroll > 0)
            log(
              `üìë Payroll processed: -$${payroll}.`,
              payroll > state.money ? "warn" : ""
            );

          // officer quits if money negative after payroll
          if (state.money < 0 && state.officersTotal > state.baseFree) {
            const quitting = Math.min(1, state.officersTotal - state.baseFree);
            state.officersTotal -= quitting;
            // Prefer to reduce free officers; if none, reduce missions? We'll reduce free.
            const freeToReduce = Math.min(quitting, state.officersFree);
            state.officersFree -= freeToReduce;
            log(`üßë‚Äç‚úàÔ∏è ${quitting} officer quit due to unpaid salary.`, "bad");
          }

          // funding every 5 days
          if (state.day % 5 === 0) {
            state.money += 250;
            log("üèõÔ∏è City funding received: +$250.", "good");
          }

          renderHUD();
        }

        // ---------- DRILL ----------
        function startDrill() {
          if (state.officersFree < 1) {
            log("Need 1 free officer for a drill.", "warn");
            return;
          }
          if (state.money < 60) {
            log("Not enough money for drill.", "warn");
            return;
          }
          state.money -= 60;
          state.officersFree -= 1;
          renderHUD();
          $("#drillStatus").textContent = "Drill in progress (20s)";
          log("üéØ Drill started: 1 officer assigned for 20s.");
          const endAt = Date.now() + 20000;
          const interval = setInterval(() => {
            const left = endAt - Date.now();
            if (left <= 0) {
              clearInterval(interval);
              state.officersFree += 1;
              renderHUD();
              state.drillBuff.active = true;
              state.drillBuff.until = Date.now() + 90000; // 90s buff
              $("#drillStatus").textContent =
                "Buff active: +5% success for 90s";
              log("üéñÔ∏è Drill completed. Temporary +5% success for 90s.", "good");
            }
          }, 500);
        }

        // ---------- LOOP ----------
        let nextSpawnIn = between(state.spawnMin, state.spawnMax);
        function loop() {
          const dtReal = 200; // frame step in ms
          const dt = dtReal * (state.paused ? 0 : state.speed);

          // spawner
          nextSpawnIn -= dt;
          if (nextSpawnIn <= 0) {
            spawnIncident();
            const repBoost = Math.max(0, state.reputation);
            const min = Math.max(4000, state.spawnMin - repBoost * 150);
            const max = Math.max(7000, state.spawnMax - repBoost * 120);
            nextSpawnIn = between(min, max);
          }

          // countdown incidents
          state.incidents = state.incidents.filter((inc) => {
            inc.expiresAt -= dt;
            if (inc.expiresAt <= Date.now()) {
              failExpired(inc);
              return false; // remove
            }
            return true;
          });

          // resolve missions
          const now2 = Date.now();
          const done = [];
          state.missions.forEach((m) => {
            if (now2 >= m.resolveAt) done.push(m);
          });
          done.forEach((m) => {
            resolveMission(m);
            state.missions = state.missions.filter((x) => x !== m);
          });

          // day cycle
          if (!state.paused && Date.now() >= state.nextDayAt) {
            state.nextDayAt += state.msPerDay;
            onNewDay();
          }

          // drill buff expiry
          if (state.drillBuff.active && Date.now() >= state.drillBuff.until) {
            state.drillBuff.active = false;
            $("#drillStatus").textContent = "No drill active.";
            log("üéñÔ∏è Drill buff expired.");
          }

          // render
          renderHUD();
          renderIncidents();
          renderMissions();

          requestAnimationFrame(loop);
        }

        // ---------- EVENTS ----------
        $("#dispatchBtn").onclick = dispatchSelected;
        $("#clearBtn").onclick = () => {
          selectIncident(null);
          state.paused = false;
          $("#pauseBtn").textContent = "‚è∏Ô∏è Pause";
        };
        $("#fillReqBtn").onclick = () => {
          const inc = state.incidents.find((i) => i.id === state.selectedId);
          if (!inc) return;
          $("#sendCount").value = Math.min(inc.required, state.officersFree);
        };
        $("#maxBtn").onclick = () => {
          $("#sendCount").value = state.officersFree;
        };
        $("#spawnBtn").onclick = spawnIncident;
        $("#pauseBtn").onclick = () => {
          state.paused = !state.paused;
          $("#pauseBtn").textContent = state.paused ? "‚ñ∂Ô∏è Resume" : "‚è∏Ô∏è Pause";
        };
        document.querySelectorAll("[data-speed]").forEach((btn) =>
          btn.addEventListener("click", () => {
            state.speed = Number(btn.dataset.speed || 1);
            state.paused = false;
            $("#pauseBtn").textContent = "‚è∏Ô∏è Pause";
          })
        );

        // Patrols
        $("#addPatrolBtn").onclick = addPatrol;

        // Shop
        const shop = $("#shopOverlay");
        function openShop() {
          // pause but keep background visible (no blur)
          state.paused = true;
          $("#pauseBtn").textContent = "‚ñ∂Ô∏è Resume";
          $("#shopMoney").textContent = state.money.toFixed(0);
          $("#shopOfficers").textContent = state.officersTotal;
          $("#shopDay").textContent = state.day;
          shop.classList.add("show");
        }
        function closeShop() {
          shop.classList.remove("show");
        }
        $("#shopBtn").onclick = openShop;
        $("#closeShop").onclick = closeShop;

        // Hire in shop ‚Äì fixed so it always updates game state
        $("#hireBtn").onclick = () => {
          const c = Math.max(1, Math.floor(Number($("#hireCount").value || 1)));
          const cost = 150 * c;
          const msg = $("#hireMsg");
          if (state.money < cost) {
            msg.textContent = "Not enough money.";
            return;
          }
          state.money -= cost;
          state.officersTotal += c;
          state.officersFree += c;
          msg.textContent = `Hired ${c} officer(s) for $${cost}.`;
          $("#shopMoney").textContent = state.money.toFixed(0);
          $("#shopOfficers").textContent = state.officersTotal;
          renderHUD();
          log(`üëÆ Hired ${c} officer(s) for $${cost}.`);
        };

        // Drill in shop
        $("#startDrillBtn").onclick = startDrill;

        // Clicking an incident also selects it
        elIncidents.addEventListener("click", (e) => {
          const card = e.target.closest(".incident");
          if (!card) return;
          selectIncident(Number(card.dataset.id), true);
        });

        // ---------- START ----------
        renderHUD();
        spawnIncident();
        spawnIncident();
        renderPatrols();
        loop();
      })();
    </script>
  </body>
</html>
